<%- include('../partials/header') %>

<div class="container-fluid p-4">
  <div class="card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h3>Invoice Detail</h3>
      <div>
        <button class="btn btn-outline-primary">
          <i class="fas fa-print me-2"></i>Print
        </button>
        <button class="btn btn-success" onclick="updateStatus('<%= invoice.id %>', 'sent')">
          <i class="fas fa-paper-plane me-2"></i>Mark as Sent
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="row mb-4">
        <div class="col-md-6">
          <h5>Invoice <%= invoice.invoice_number %></h5>
          <p><strong>Status:</strong> 
            <span class="badge bg-<%= invoice.status === 'paid' ? 'success' : 'warning' %>">
              <%= invoice.status.toUpperCase() %>
            </span>
          </p>
        </div>
        <div class="col-md-6 text-end">
          <p><strong>Issue Date:</strong> <%= moment(invoice.issue_date).format('MMM DD, YYYY') %></p>
          <p><strong>Due Date:</strong> <%= moment(invoice.due_date).format('MMM DD, YYYY') %></p>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <h6>Bill To:</h6>
          <p><strong><%= invoice.contact.name %></strong></p>
        </div>
        <% if (invoice.matter) { %>
          <div class="col-md-6">
            <h6>Related Matter:</h6>
            <p><%= invoice.matter.matter_name %></p>
          </div>
        <% } %>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody>
          <% invoice.bills.forEach(bill => { %>
            <tr>
              <td><%= bill.description %></td>
              <td><%= bill.quantity %></td>
              <td>Rp <%= parseFloat(bill.unit_price).toLocaleString() %></td>
              <td class="text-end">Rp <%= parseFloat(bill.amount).toLocaleString() %></td>
            </tr>
          <% }); %>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
            <td class="text-end">Rp <%= parseFloat(invoice.subtotal).toLocaleString() %></td>
          </tr>
          <% if (invoice.tax_amount > 0) { %>
            <tr>
              <td colspan="3" class="text-end"><strong>Tax (<%= invoice.tax_rate %>%):</strong></td>
              <td class="text-end">Rp <%= parseFloat(invoice.tax_amount).toLocaleString() %></td>
            </tr>
          <% } %>
          <% if (invoice.discount_amount > 0) { %>
            <tr>
              <td colspan="3" class="text-end"><strong>Discount:</strong></td>
              <td class="text-end">- Rp <%= parseFloat(invoice.discount_amount).toLocaleString() %></td>
            </tr>
          <% } %>
          <tr>
            <td colspan="3" class="text-end"><h5>Total:</h5></td>
            <td class="text-end"><h5>Rp <%= parseFloat(invoice.total_amount).toLocaleString() %></h5></td>
          </tr>
        </tfoot>
      </table>

      <div class="mt-4">
        <a href="/invoices" class="btn btn-secondary">Back to Invoices</a>
      </div>
    </div>
  </div>
</div>

<script>
function updateStatus(id, status) {
  fetch(`/invoices/${id}/status`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) location.reload();
  });
}
</script>

<%- include('../partials/footer') %>
