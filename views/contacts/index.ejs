<%- include('../partials/header') %>

<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-address-book me-2"></i>Contacts</h2>
    <a href="/contacts/add" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i>Add Contact
    </a>
  </div>

  <!-- Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" action="/contacts" class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="search" placeholder="Search contacts..." value="<%= search %>">
        </div>
        <div class="col-md-3">
          <select class="form-select" name="filter" onchange="this.form.submit()">
            <option value="all"<% if (filter === 'all') { %> selected<% } %>>All Contacts</option>
            <option value="client"<% if (filter === 'client') { %> selected<% } %>>Clients Only</option>
            <option value="non-client"<% if (filter === 'non-client') { %> selected<% } %>>Non-Clients Only</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-secondary w-100">
            <i class="fas fa-search me-2"></i>Search
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contacts Table -->
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Type</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Client</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (contacts.length > 0) { %>
              <% contacts.forEach(contact => { %>
                <tr>
                  <td><span class="badge bg-info"><%= contact.entity_type %></span></td>
                  <td><strong><%= contact.name %></strong></td>
                  <td><%= contact.emails && contact.emails[0] ? contact.emails[0].email : '-' %></td>
                  <td><%= contact.phones && contact.phones[0] ? contact.phones[0].phone : '-' %></td>
                  <td><%= contact.addresses && contact.addresses[0] ? contact.addresses[0].address : '-' %></td>
                  <td>
                    <% if (contact.is_client) { %>
                      <span class="badge bg-success">Yes</span>
                    <% } else { %>
                      <span class="badge bg-secondary">No</span>
                    <% } %>
                  </td>
                  <td>
                    <a href="/contacts/<%= contact.id %>/edit" class="btn btn-sm btn-outline-primary">
                      <i class="fas fa-edit"></i>
                    </a>
                    <button onclick="deleteContact(<%= contact.id %>)" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="7" class="text-center text-muted">No contacts found</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function deleteContact(id) {
  if (confirm('Are you sure you want to delete this contact?')) {
    fetch(`/contacts/${id}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.message);
      }
    });
  }
}
</script>

<%- include('../partials/footer') %>
